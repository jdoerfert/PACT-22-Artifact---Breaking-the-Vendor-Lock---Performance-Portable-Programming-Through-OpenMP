// #ifdef __cplusplus
// extern "C" {
// #endif

//========================================================================================================================================================================================================200
//	DEFINE / INCLUDE
//========================================================================================================================================================================================================200

//======================================================================================================================================================150
//	COMMON
//======================================================================================================================================================150

#include "../common.h"									// (in path provided here)

//======================================================================================================================================================150
//	KERNEL
//======================================================================================================================================================150

#include "./kernel_fin.c"									// (in path provided here)

#include "kernel_ecc.sycl"
#include "kernel_cam.sycl"

//======================================================================================================================================================150
//	LIBRARIES
//======================================================================================================================================================150

#include <stdio.h>										// (in path known to compiler)	needed by printf
//======================================================================================================================================================150
//	END
//======================================================================================================================================================150

//========================================================================================================================================================================================================200
//	MAIN FUNCTION
//========================================================================================================================================================================================================200

void 
master(	FP timeinst,
    FP *initvalu,
    FP *parameter,
    FP *finavalu,
    FP *com,

    buffer<FP,1>& d_initvalu,
    buffer<FP,1>& d_finavalu,
    buffer<FP,1>& d_params,
    buffer<FP,1>& d_com,

    queue &command_queue,

    long long *timecopyin,
    long long *timekernel,
    long long *timecopyout)
{

  //======================================================================================================================================================150
  //	VARIABLES
  //======================================================================================================================================================150

  //timer
  long long time0;
  long long time1;
  long long time2;
  long long time3;

  // counters
  int i;

  // offset pointers
  int initvalu_offset_ecc;																// 46 points
  int initvalu_offset_Dyad;															// 15 points
  int initvalu_offset_SL;																// 15 points
  int initvalu_offset_Cyt;																// 15 poitns

#ifdef DEBUG
  for (int i = 0; i < EQUATIONS; i++)
          printf("initvalu %d %f\n", i, initvalu[i]);
  for (int i = 0; i < PARAMETERS; i++)
          printf("params %d %f\n", i, parameter[i]);
  printf("\n");
#endif

  // common variables
  time0 = get_time();

  //======================================================================================================================================================150
  //	COPY DATA TO GPU MEMORY
  //======================================================================================================================================================150

  //====================================================================================================100
  //	initvalu
  //====================================================================================================100

  command_queue.submit([&](handler& cgh) {
      accessor<FP, 1, access::mode::write, access::target::global_buffer> 
      d_initvalu_acc(d_initvalu, cgh, range<1>(EQUATIONS), id<1>(0));
      cgh.copy(initvalu, d_initvalu_acc);
  });

  command_queue.submit([&](handler& cgh) {
      accessor<FP, 1, access::mode::write, access::target::global_buffer> 
      d_params_acc(d_params, cgh, range<1>(PARAMETERS), id<1>(0));
      cgh.copy(parameter, d_params_acc);
  });


  time1 = get_time();

  //======================================================================================================================================================150
  //	GPU: KERNEL
  //======================================================================================================================================================150

  //====================================================================================================100
  //	KERNEL EXECUTION PARAMETERS
  //====================================================================================================100

  size_t local_work_size = NUMBER_THREADS;
  size_t global_work_size = 2*NUMBER_THREADS;

  // printf("# of blocks = %d, # of threads/block = %d (ensure that device can handle)\n", (int)global_work_size[0]/(int)local_work_size[0], (int)local_work_size[0]);
  command_queue.submit([&](handler &cgh) {
      // Getting write only access to the buffer on a device
      auto d_initvalu_acc = d_initvalu.get_access<sycl_read>(cgh);
      auto d_finavalu_acc = d_finavalu.get_access<sycl_write>(cgh);
      auto d_params_acc = d_params.get_access<sycl_read>(cgh);
      auto d_com_acc = d_com.get_access<sycl_write>(cgh);
      // Executing kernel
      cgh.parallel_for<class sycl_kernel >(
        nd_range<1>(range<1>(global_work_size),
          range<1>(local_work_size)), [=] (nd_item<1> item) {
#include "kernel.sycl"
        });
      });

  time2 = get_time();

  //======================================================================================================================================================150
  //	COPY DATA TO SYSTEM MEMORY
  //======================================================================================================================================================150

  //====================================================================================================100
  //	com
  //====================================================================================================100

  command_queue.submit([&](handler& cgh) {
      accessor<FP, 1, sycl_read, access::target::global_buffer> 
      d_finavalu_acc(d_finavalu, cgh, range<1>(EQUATIONS), id<1>(0));
      cgh.copy(d_finavalu_acc, finavalu);
      });

  command_queue.submit([&](handler& cgh) {
      accessor<FP, 1, sycl_read, access::target::global_buffer> 
      d_com_acc(d_com, cgh, range<1>(3), id<1>(0));
      cgh.copy(d_com_acc, com);
      });
  command_queue.wait();

#ifdef DEBUG
  for (int i = 0; i < EQUATIONS; i++)
          printf("finavalu %d %f\n", i, finavalu[i]);
  for (int i = 0; i < 3; i++)
          printf("%f ", com[i]);
  printf("\n");

#endif


  //====================================================================================================100
  //	END
  //====================================================================================================100

  time3 = get_time();

  //======================================================================================================================================================150
  //	CPU: FINAL KERNEL
  //======================================================================================================================================================150

  // *copyin_time,
  // *kernel_time,
  // *copyout_time)

  timecopyin[0] = timecopyin[0] + (time1-time0);
  timekernel[0] = timekernel[0] + (time2-time1);
  timecopyout[0] = timecopyout[0] + (time3-time2);

  //======================================================================================================================================================150
  //	CPU: FINAL KERNEL
  //======================================================================================================================================================150

  initvalu_offset_ecc = 0;												// 46 points
  initvalu_offset_Dyad = 46;												// 15 points
  initvalu_offset_SL = 61;												// 15 points
  initvalu_offset_Cyt = 76;												// 15 poitns

  kernel_fin(	initvalu,
      initvalu_offset_ecc,
      initvalu_offset_Dyad,
      initvalu_offset_SL,
      initvalu_offset_Cyt,
      parameter,
      finavalu,
      com[0],
      com[1],
      com[2]);

  //======================================================================================================================================================150
  //	COMPENSATION FOR NANs and INFs
  //======================================================================================================================================================150

  for(i=0; i<EQUATIONS; i++){
    if (std::isnan(finavalu[i])){ 
      finavalu[i] = 0.0001;												// for NAN set rate of change to 0.0001
    }
    else if (std::isinf(finavalu[i])){ 
      finavalu[i] = 0.0001;												// for INF set rate of change to 0.0001
    }
  }

  //======================================================================================================================================================150
  //	END
  //======================================================================================================================================================150

}

//========================================================================================================================================================================================================200
//	END
//========================================================================================================================================================================================================200

// #ifdef __cplusplus
// }
// #endif
