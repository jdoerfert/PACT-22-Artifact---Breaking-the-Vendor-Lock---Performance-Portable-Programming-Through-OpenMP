#include <stdio.h>
#include <string.h>
#include "../common.h"
#include "../util/timer/timer.h" 
#include "./solver.c"
#include "kernel_wrapper.h"          // (in directory)



int 
kernel_wrapper(  int xmax,
    int workload,
    FP ***y,
    FP **x,
    FP **params,
    FP *com)
{

  //======================================================================================================================================================150
  //  VARIABLES
  //======================================================================================================================================================150

  long long time0;
  long long time4;
  long long timecopyin;
  long long timekernel;
  long long timecopyout;

  time0 = get_time();

  { // sycl scope
    int i;

    //======================================================================================================================================================150
    //  GPU SETUP
    //======================================================================================================================================================150
#ifdef USE_GPU
    gpu_selector dev_selector;
#else
    cpu_selector dev_selector;
#endif
    queue command_queue(dev_selector);

    //====================================================================================================100
    //  COMMON VARIABLES
    //====================================================================================================100

    //======================================================================================================================================================150
    //  ALLOCATE MEMORY
    //======================================================================================================================================================150

    buffer<FP,1> d_initvalu(EQUATIONS);
    buffer<FP,1> d_finavalu(EQUATIONS);
    buffer<FP,1> d_params(PARAMETERS);
    buffer<FP,1> d_com(3);


    //======================================================================================================================================================150
    //  EXECUTION
    //======================================================================================================================================================150

    int status;

    for(i=0; i<workload; i++){

      status = solver(  y[i],
          x[i],
          xmax,
          params[i],
          com,

          d_initvalu,
          d_finavalu,
          d_params,
          d_com,

          command_queue,

          &timecopyin,
          &timekernel,
          &timecopyout);

      if(status !=0){
        printf("STATUS: %d\n", status);
      }

    }

    // // // print results
    // // int k;
    // // for(i=0; i<workload; i++){
    // // printf("WORKLOAD %d:\n", i);
    // // for(j=0; j<(xmax+1); j++){
    // // printf("\tTIME %d:\n", j);
    // // for(k=0; k<EQUATIONS; k++){
    // // printf("\t\ty[%d][%d][%d]=%13.10f\n", i, j, k, y[i][j][k]);
    // // }
    // // }
    // // }

    //================================================================================================================================================150
    //  DISPLAY TIMING
    //======================================================================================================================================================150
  } // sycl scope

  time4 = get_time();

  printf("Device offloading time:\n");
  printf("%.12f s\n", (float) (time4-time0) / 1000000);

  //======================================================================================================================================================150
  //  RETURN
  //======================================================================================================================================================150

  return 0;

  //======================================================================================================================================================150
  //  END
  //======================================================================================================================================================150

}

